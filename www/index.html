<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport"
	      content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, viewport-fit=cover">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="theme-color" content="#c1e6e07d">
	<!-- <meta http-equiv="Content-Security-Policy" content="default-src * 'self' 'unsafe-inline' 'unsafe-eval' data: gap:"> -->
	<title>Aplikasi Kunjungan</title>
	<link rel="stylesheet" href="core/css/framework7.bundle.min.css">
	<link rel="stylesheet" href="css/app.css">
	<link rel="apple-touch-icon" href="img/f7-icon-square.png">
	<link rel="icon" href="img/logo-kab-jombang.png">
	<!-- memanggil link js dan css dari pihak mapbox -->
	<link href="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.css" rel="stylesheet">
	<script src="https://api.mapbox.com/mapbox-gl-js/v2.5.1/mapbox-gl.js"></script>
	<style>
		/*#map {*/
		/*    position: absolute;*/
		/*    top: 0;*/
		/*    bottom: 0;*/
		/*    width: 100%;*/
		/*}*/

		.jedatombol {
			margin-right: 3%;
			margin-left: 3%;
		}

		.marginkonten {
			margin-right: 10px;
			margin-left: 10px;
		}

		.full {
			width: 100%;
		}

		.besar-icon {
			width: 75%;
		}

		.slidergambar {
			width: 100%;
			height: 250px;
		}

		.icontengah {
			margin-bottom: 3%;
			display: block;
			margin-left: auto;
			margin-right: auto;
			text-align: center;
			width: 60%;
		}


		.sidebarSendiri {
			position: absolute;
			width: 33.3333%;
			height: 100%;
			top: 0;
			left: 0;
			overflow: hidden;
			border-right: 1px solid rgba(0, 0, 0, 0.25);
		}

		.map {
			position: absolute;
			left: 33.3333%;
			width: 66.6666%;
			top: 0;
			bottom: 0;
		}

		a:hover {
			color: #101010;
		}

		.headingSendiri {
			background: #fff;
			border-bottom: 1px solid #eee;
			min-height: 60px;
			line-height: 60px;
			padding: 0 10px;
			background-color: #00853e;
			color: #fff;
			display: flex;
			justify-content: space-between;
		}

		.listings {
			height: 100%;
			overflow: auto;
			padding-bottom: 60px;
		}

		.listings .item {
			display: block;
			border-bottom: 1px solid #eee;
			padding: 10px;
			text-decoration: none;
		}

		.listings .item:last-child {
			border-bottom: none;
		}

		.listings .item .title {
			display: block;
			color: #00853e;
			font-weight: 700;
		}

		.listings .item .title small {
			font-weight: 400;
		}

		.listings .item.active .title,
		.listings .item .title:hover {
			color: #8cc63f;
		}

		.listings .item.active {
			background-color: #f8f8f8;
		}

		::-webkit-scrollbar {
			width: 3px;
			height: 3px;
			border-left: 0;
			background: rgba(0, 0, 0, 0.1);
		}

		::-webkit-scrollbar-track {
			background: none;
		}

		::-webkit-scrollbar-thumb {
			background: #00853e;
			border-radius: 0;
		}

		.marker {
			border: none;
			cursor: pointer;
			height: 56px;
			width: 56px;
			background-image: url(./pages/marker.png);
		}

		/* Marker tweaks */
		.mapboxgl-popup {
			padding-bottom: 50px;
		}

		.mapboxgl-popup-close-button {
			display: none;
		}

		.mapboxgl-popup-content {
			font: 400 15px/22px 'Source Sans Pro', 'Helvetica Neue', sans-serif;
			padding: 0;
			width: 180px;
		}

		.mapboxgl-popup-content h3 {
			background: #91c949;
			color: #fff;
			margin: 0;
			padding: 10px;
			border-radius: 3px 3px 0 0;
			font-weight: 700;
			margin-top: -15px;
		}

		.mapboxgl-popup-content h5 {
			margin: 0;
			padding-left: 10px;
			font-weight: 300;
		}

		.mapboxgl-popup-content div {
			padding: 10px;
		}

		.mapboxgl-popup-anchor-top > .mapboxgl-popup-content {
			margin-top: 15px;
		}

		.mapboxgl-popup-anchor-top > .mapboxgl-popup-tip {
			border-bottom-color: #91c949;
		}

		/* #btnBackPeta {

			background-color: #007838;
			border-radius: 50px;
			width: 30px;
			height: 30px;

		} */


		.add-data {
			text-align: center !important;
			justify-content: center !important;
			border-radius: 25px !important;
			min-width: 29px !important;
			height: 29px !important;
			background-image: linear-gradient(45deg, #7ece4c, #31ffff);
		}
	</style>
</head>

<body>
<div id="app">
	<div class="view view-main view-init safe-area-left" data-master-detail-breakpoint="800" data-url="/">
		<div class="page page-home">

			<div class="navbar navbar-large navbar-transparent">
				<div class="navbar-bg"></div>
				<div class="navbar-inner">
					<div class="left">
						<div style="width: 2.7rem; aspect-ratio: 1/1; overflow: hidden;">
							<img src="./img/logo-kab-jombang.png" style="width: 100%; display: block;">
						</div>
					</div>
					<div class="title sliding">Pemetaan Jambu</div>
					<div class="right">
						<a href="#" class="link popover-open" data-popover=".popover-menu">
							<i class="f7-icons">ellipsis_vertical</i>
						</a>
					</div>
					<div class="title-large">
						<div class="title-large-text">MENU</div>
					</div>
				</div>
			</div>

			<!-- halaman utama -->
			<div class="page-content" style="background-color: #c1e6e07d;">
				<div class="card"
				     style="margin-left: 15px; margin-right: 15px; margin-bottom: 10px; border-radius: 20px;">
					<div class="card-content card-content-padding">
						<p class="row" style="margin-bottom: 15px;">
							<a href="/titik-lokasi/" class="col text-align-center" style="color: black">
								<img src="img/compose.png" class="besar-icon"><br>Titik Lokasi
							</a>
							<a href="/tambah-lokasi/" class="col text-align-center" style="color: black">
								<img src="img/shop.png" class="besar-icon"><br>Tambah Lokasi
							</a>
						</p>
						<p class="row" style="margin-bottom: 15px;">
							<a href="/pengguna/" class="col text-align-center sheet-open"
							   data-sheet="#sheet-data" style="color: black">
								<img src="img/bookshelf.png" class="besar-icon"><br>Pengguna
							</a>
							<a href="/ganti-password/" class="col text-align-center" style="color: black">
								<img src="img/key.png" class="besar-icon"><br>Ganti Password
							</a>
						</p>
						<p class="row" style="margin-bottom: 15px;">
							<a href="/rekap-varietas/" class="col text-align-center" style="color: black">
								<img src="img/clipboard.png" class="besar-icon"><br>Rekap Varietas
							</a>
							<a href="/tentang/" class="col text-align-center" style="color: black">
								<img src="img/smartphone.png" class="besar-icon"><br>Tentang Aplikasi
							</a>
						</p>
					</div>
				</div>

				<div id="blok_data_kota" class="list">
				</div>

				<!-- modal login -->
				<div class="login-screen">
					<div class="page login-screen-page"
					     style="background-image: linear-gradient(45deg, #9be8df, #a8e0ae87);">
						<div class="page-content login-screen-content" style="background: transparent;">
							<div class="login-screen-title">Aplikasi Pemetaan <br>Login</div>
							<form>
								<div class="list">
									<ul id="html_screen">
									</ul>
								</div>
								<div class="list block">
									<ul>
										<li>
											<a href="javascript:void(0)"
											   class="col button button-fill color-blue"
											   onclick="click_proses()">Proses</a>
										</li>
									</ul>
									<div class="block-footer">
										Aplikasi Pemetaan Lorem ipsum dolor sit amet consectetur adipisicing elit. Optio
										vel ab dolores saepe sequi inventore culpa in dolor sapiente, accusantium magni
										rerum beatae dignissimos minima amet. Cupiditate ipsa expedita earum.
									</div>
								</div>
							</form>
						</div>
					</div>
				</div>
				<!-- modal login -->
			</div>

			<div class="popover popover-menu">
				<div class="popover-angle"></div>
				<div class="popover-inner">
					<div class="list">
						<ul>
							<li>
								<a href="javascript:void(0)" class="list-button popover-close" onclick="click_logout()">Logout</a>
							</li>
						</ul>
					</div>
				</div>
			</div>

		</div>
	</div>

	<script src="core/js/framework7.bundle.min.js"></script>
	<script src="js/routes.js"></script>
	<script src="js/app.js"></script>
	<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	<script src="js/data-titik-lokasi.js"></script>
	<script type="text/javascript" charset="utf-8">
		cek_localstorage();

		function cek_localstorage() {
			if (localStorage.ls_id_user == '' || localStorage.ls_id_user == undefined) {
				cek_tabel_users();
			}
		}

		function cek_tabel_users() {
			app.preloader.show();
			// cek tabel users
			app.request.post(api_users_cek_data, function (data, status, xhr) {
				var data = JSON.parse(data);
				console.log(data);
				console.log(data['status']);
				console.log(data.status);
				console.log(status);
				// console.log(xhr);

				app.preloader.hide();

				if (data['status'] === 'sukses') {
					// proses login
					var hasil = `<li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Nama User</div>
                            <div class="item-input-wrap">
                                <input type="hidden" name="val_jenis" id="val_jenis" value="login">
                                <input type="text" name="val_username" id="val_username" placeholder="Masukan username" autofocus>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Password</div>
                            <div class="item-input-wrap">
                                <input type="password" name="val_password" id="val_password" placeholder="Masukan password">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>`;
					$('.login-screen-title').html('Aplikasi Pemetaan <br>Jambu Darsono<br> Login');
				} else {
					// proses register
					var hasil = `<li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Nama Lengkap</div>
                            <div class="item-input-wrap">
                                <input type="hidden" name="val_jenis" id="val_jenis" value="register">
                                <input type="text" name="val_nama" id="val_nama" placeholder="Nama Lengkap sesuai KTP" autofocus>
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Username</div>
                            <div class="item-input-wrap">
                                <input type="text" name="val_username" id="val_username" placeholder="Masukan Username">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Password</div>
                            <div class="item-input-wrap">
                                <input type="password" name="val_password" id="val_password" placeholder="Masukan password">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>
                    <li class="item-content item-input">
                        <div class="item-inner">
                            <div class="item-title item-label">Nomor Hp/WhatsApp</div>
                            <div class="item-input-wrap">
                                <input type="number" name="val_nomor" id="val_nomor" placeholder="contoh: 628xxxxxxxxxx">
                                <span class="input-clear-button"></span>
                            </div>
                        </div>
                    </li>`;
					$('.login-screen-title').html('Aplikasi Pemetaan <br>Jambu Darsono<br> Register');
				}
				$('#html_screen').html(hasil);
				app.loginScreen.open('.login-screen');

			}, {}, function (xhr, status, message) {
				// menampilkan jika ada error
				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}

		function click_proses() {
			var j = $('#val_jenis').val();
			var u = $('#val_username').val();
			var p = $('#val_password').val();

			if (u == '' || p == '') {
				app.dialog.alert('Lengkapi Data', 'Pemberitahuan');
			} else {
				if (j == 'login') {
					app.preloader.show();
					app.request.post(api_users_login, {
						username: u,
						password: p,
					}, function (data, status, xhr) {
						console.log(data);
						console.log(status);
						// console.log(xhr);
						app.preloader.hide();

						app.dialog.alert(data['message'], 'Pemberitahuan');
						if (data['status'] === 'sukses') {
							var id_user = data['data']['id'];
							var nama = data['data']['nama'];
							// mmbuat session
							localStorage.setItem('ls_id_user', id_user);
							localStorage.setItem('ss_nama_lengkap', nama);
							app.loginScreen.close('.login-screen');
						}
					}, function (xhr, status, message) {
						// menampilkan jika ada error
						// console.log(xhr);
						console.log(status);
						console.log(message);

						// panggil fungsi untuk menampilkan error
						info_error(status);
					}, "json");
				} else {
					var na = $('#val_nama').val();
					var no = $('#val_nomor').val();
					if (na == '' || no == '') {
						app.dialog.alert('Lengkapi Data', 'Pemberitahuan');
					} else {
						app.preloader.show();
						app.request.post(api_users_register, {
							nama: na,
							username: u,
							password: p,
							nomor: no,
						}, function (data, status, xhr) {
							console.log(data);
							console.log(status);
							// console.log(xhr);
							app.preloader.hide();

							if (data['status'] === 'sukses') {
								cek_tabel_users();
							}
							app.dialog.alert(data['message'], 'Pemberitahuan');

						}, function (xhr, status, message) {
							// menampilkan jika ada error
							// console.log(xhr);
							console.log(status);
							console.log(message);

							// panggil fungsi untuk menampilkan error
							info_error(status);
						}, "json");
					}
				}
			}
			console.log();

		}

		function click_logout() {
			localStorage.removeItem('ls_id_user');
			localStorage.removeItem('ss_nama_lengkap');
			cek_tabel_users();
			app.popover.close('.popover-menu');
		}

		window.screen.orientation.lock('portrait-primary');

		/**
		 * Add a marker to the map for every store listing.
		 **/
		function addMarkers(stores, map) {
			/* For each feature in the GeoJSON object above: */
			for (const marker of stores.features) {
				/* Create a div element for the marker. */
				const el = document.createElement('div');
				/* Assign a unique `id` to the marker. */
				el.id = `marker-${marker.properties.id}`;
				/* Assign the `marker` class to each marker for styling. */
				el.className = 'marker';

				/**
				 * Create a marker using the div element
				 * defined above and add it to the map.
				 * [0, -23]
				 **/
				new mapboxgl.Marker(el, {
					offset: [0, -2]
				})
						.setLngLat(marker.geometry.coordinates)
						.addTo(map);

				/**
				 * Listen to the element and when it is clicked, do three things:
				 * 1. Fly to the point
				 * 2. Close all other popups and display popup for clicked store
				 * 3. Highlight listing in sidebarSendiri (and remove highlight for all other listings)
				 **/
				el.addEventListener('click', (e) => {
					/* Fly to the point */
					flyToStore(marker, map);
					/* Close all other popups and display popup for clicked store */
					createPopUp(marker, map);
					/* Highlight listing in sidebarSendiri */
					const activeItem = document.getElementsByClassName('active');
					e.stopPropagation();
					if (activeItem[0]) {
						activeItem[0].classList.remove('active');
					}
					const listing = document.getElementById(
							`listing-${marker.properties.id}`
					);
					listing.classList.add('active');
				});
			}
		}

		/**
		 * Add a listing for each store to the sidebarSendiri.
		 **/
		function buildLocationList(stores, map) {
			const listings_remove = document.getElementById('listings');
			listings_remove.innerHTML = '';

			for (const store of stores.features) {
				/* Add a new listing section to the sidebarSendiri. */
				const listings = document.getElementById('listings');
				const listing = listings.appendChild(document.createElement('div'));
				/* Assign a unique `id` to the listing. */
				listing.id = `listing-${store.properties.id}`;
				/* Assign the `item` class to each listing for styling. */
				listing.className = 'item';

				/* Add the link to the individual listing created above. */
				const link = listing.appendChild(document.createElement('a'));
				link.href = '#';
				link.className = 'title';
				link.style = `color: #404040; text-decoration: none;`;
				link.id = `link-${store.properties.id}`;
				link.innerHTML = `${store.properties.nama_jenis_buah}`;

				/* Add details to the individual listing. */
				const details = listing.appendChild(document.createElement('div'));
				details.innerHTML = `${store.properties.nama_buah}`;
				// if (store.properties.nama) {
				details.innerHTML += ` &middot; User: ${store.properties.nama_user}`;
				// }

				link.addEventListener('click', function () {
					for (const feature of stores.features) {
						if (this.id === `link-${feature.properties.id}`) {
							flyToStore(feature, map);
							createPopUp(feature, map);
						}
					}
					const activeItem = document.getElementsByClassName('active');
					if (activeItem[0]) {
						activeItem[0].classList.remove('active');
					}
					this.parentNode.classList.add('active');
				});
			}

			if (stores.features.length >= 5) {
				var listings_akhir = (stores.features.length - 1)
				const listings2 = document.getElementById('listing-' + listings_akhir);
				listings2.style = `padding-bottom: 70px;`;
			}
		}

		function flyToStore(currentFeature, map) {
			click_cancel_cari();
			map.flyTo({
				center: currentFeature.geometry.coordinates,
				zoom: 17
			});
		}

		/**
		 * Create a Mapbox GL JS `Popup`.
		 **/
		function createPopUp(currentFeature, map) {
			const popUps = document.getElementsByClassName('mapboxgl-popup');
			if (popUps[0]) popUps[0].remove();
			const popup = new mapboxgl.Popup({
				closeOnClick: false
			})
					.setLngLat(currentFeature.geometry.coordinates)
					.setHTML(`
                    <h3>${currentFeature.properties.nama_pemilik}</h3>
                    <h5>Jenis: <strong>${currentFeature.properties.nama_jenis_buah}<strong></h5>
                    <h5>Dusun: <strong>${currentFeature.properties.nama_dusun}<strong></h5>
                    <h5>Ket: <strong>${currentFeature.properties.keterangan}<strong>...<a onclick="click_keterangan('${currentFeature.properties.id_set_titik_lokasi}')">Baca</a></h5>
                `)
					.addTo(map);
		}

		function info_error(status) {
			if (status == 404) {
				app.dialog.alert('Tidak ditemukan [404]', 'Warning');
			} else {
				app.dialog.alert('API Error [500]', 'Info');
			}
			app.preloader.hide();
		}

		function preload_div(id) {
			var hasil = `<div class="block block-strong text-align-center">
                <div class="preloader color-multi">
                    <span class="preloader-inner">
                        <span class="preloader-inner-gap"></span>
                        <span class="preloader-inner-left">
                            <span class="preloader-inner-half-circle"></span>
                        </span>
                        <span class="preloader-inner-right">
                            <span class="preloader-inner-half-circle"></span>
                        </span>
                    </span>
                </div>
            </div>`;
			$('#' + id).html(hasil);
		}

		// TAMBAHH-LOKASII
		function click_titik_lokasi_sekarang() {
			// -7.5216032,112.2381195
			// var hasil = '';
			app.preloader.show();
			var options = {
				enableHighAccuracy: true,
				timeout: 5000,
				maximumAge: 0
			};
			navigator.geolocation.getCurrentPosition(onSuccess, onError, options);
		}


		var onSuccess = function (position) {
			/*
			mapbox akurasinya
			Longitude: 112.23816647541884
			Latitude: -7.521745450373089, 112.23816647541884

			versi 2
			Longitude: 112.23810750662085
			Latitude: -7.521737897893132, 112.23810750662085

			versi 3
			Longitude: 112.23808713016734
			Latitude: -7.521736166053827, 112.23808713016734
			*/
			// rumah sewa elfku -7.521729309735158, 112.23807589137019
			// -7.5216032,112.2381195
			console.log(`ini lokasi sebenarnya -7.521729309735158, 112.23807589137019 \n` +
					'Latitude: ' + position.coords.latitude + '\n' +
					'Longitude: ' + position.coords.longitude + '\n' +
					'Altitude: ' + position.coords.altitude + '\n' +
					'Accuracy: ' + position.coords.accuracy + '\n' +
					'Altitude Accuracy: ' + position.coords.altitudeAccuracy + '\n' +
					'Heading: ' + position.coords.heading + '\n' +
					'Speed: ' + position.coords.speed + '\n' +
					'Timestamp: ' + position.timestamp + '\n');
			$('#tl_long_bujur').val(position.coords.longitude);
			$('#tl_lat_lintang').val(position.coords.latitude);
			app.preloader.hide();
		};

		function onError(error) {
			console.log('code: ' + error.code + '\n' +
					'message: ' + error.message + '\n');

			setTimeout(() => {
				alert(`GPS off, Nyalakan untuk accuracy yang lebih pas. Terimakasih ${error.code}`, 'pemberitahuan');
			}, 3000);
		}

		// Options: throw an error if no update is received every 30 seconds.
		function load_titik_coordinat() {
		}

		// TITIKK-LOKASII
		class Titiklokasi {
			constructor(mapp) {
				this.mapT = mapp;
			}

			tampilMap(data_titik_lokasi) {
				const stores = data_titik_lokasi;
				/**
				 * Assign a unique id to each store. You'll use this `id`
				 * later to associate each point on the map with a listing
				 * in the sidebar.
				 */
				stores.features.forEach((store, i) => {
					store.properties.id = i;
				});

				/**
				 * Wait until the map loads to make changes to the this.mapT.
				 */
				this.mapT.on('load', () => {
					/**
					 * This is where your '.addLayer()' used to be, instead
					 * add only the source without styling a layer
					 */
					this.mapT.addSource('places', {
						'type': 'geojson',
						'data': stores
					});

					/**
					 * Add all the things to the page:
					 * - The location listings on the side of the page
					 * - The markers onto the map
					 */
					buildLocationList(stores, this.mapT);
					addMarkers(stores, this.mapT);

					// Geographic coordinates of the LineString
					const coordinates = stores.all_coordinates;

					console.log(coordinates);
					if (coordinates.length > 1) {
						// Create a 'LngLatBounds' with both corners at the first coordinate.
						const bounds = new mapboxgl.LngLatBounds(
								coordinates[0],
								coordinates[0]
						);
						console.log(bounds);

						// Extend the 'LngLatBounds' to include every coordinate in the bounds result.
						for (const coord of coordinates) {
							bounds.extend(coord);
							console.log(bounds.extend(coord));
						}

						this.mapT.fitBounds(bounds, {
							padding: 80
						});
					}
				});
			}

			mapp() {
				const mapTitikLokasi = new mapboxgl.Map({
					container: 'map',
					style: 'mapbox://styles/mapbox/light-v10',
					center: [-77.034084142948, 38.909671288923],
					zoom: 11,
					scrollZoom: true
				});
				return mapTitikLokasi;
			}

		}

		// class Clasmap {
		//   fungsi_map(){
		//     const mapTitikLokasi = new mapboxgl.Map({
		//       container: 'map',
		//       style: 'mapbox://styles/mapbox/light-v10',
		//       center: [-77.034084142948, 38.909671288923],
		//       zoom: 11,
		//       scrollZoom: true
		//     });
		//     return mapTitikLokasi;
		//   }
		// }


		function click_search() {

			const popUps = document.getElementsByClassName('mapboxgl-popup');
			if (popUps[0]) popUps[0].remove();

			var form_cari = `<div class="subnavbar" style="height: 60px; background: white;">
				<form class="searchbar searchbar-init">
			        <div class="searchbar-inner">
			            <div onclick="click_cancel_cari()" style="width: 60px; height: auto; background-color: #0087fd;" >
			                <i style="left: calc(-4px + 8px + var(--f7-safe-area-left)); width: 24px; height: 24px; margin-left: 12px; margin-top: -12px;position: absolute; left: calc(-4px + var(--f7-safe-area-left)); top: 50%;background-position: center; background-repeat: no-repeat;" class="icon icon-back"></i>
			            </div>
			            <div class="searchbar-input-wrap">
			                <input autocomplete="off" onkeyup="ketikan_kata_kunci()" style="padding-left: 0px;" type="search" id="kata_kunci" placeholder="Search"/>
			                <span class="input-clear-button"></span>
			            </div>
			            <span class="searchbar-disable-button if-not-aurora">Cancel</span>
			        </div>
			    </form>
			 </div>`;
			$('#html_heading').html(form_cari);
			setTimeout(() => {
				$('#kata_kunci').focus();
			}, 900);
		}

		function click_cancel_cari() {
			var h = `<a href="#" class="link back text-color-white" id="btnBackPeta">
		          <i class="icon icon-back"></i>
		        </a>
		        <h1 style="font-size: 22px; margin: 0; font-weight: 400; line-height: 20px; padding: 20px 2px;">Our locations</h1>

		        <a href="#" class="text-color-white" id="btnSearchPeta" onclick="click_search()">
		            <i class="icon material-icons md-only">search</i>
		        </a>`;
			$('#html_heading').html(h);
			$('#kata_kunci').val('');
			// load_lokasi_all();
		}

		// const mmap = new mapboxgl.Map({
		//   container: 'map',
		//   style: 'mapbox://styles/mapbox/light-v10',
		//   center: [-77.034084142948, 38.909671288923],
		//   zoom: 11,
		//   scrollZoom: true
		// });

		function ketikan_kata_kunci() {
			var kata_kunci = $('#kata_kunci').val();
			console.log(kata_kunci);

			app.preloader.show();
			app.request.post(api_lokasi_cari + '?s=' + kata_kunci, {
				auth_key: localStorage.ls_id_user
			}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);
				app.preloader.hide();
				if (data['status'] === 'sukses') {
					var hasil = data['data'];

					// intinya kalo diluarnegri itu dibalik dengan indonesia
					// center: [-77.034084142948, 38.909671288923],
					// center: [112.12977836991575, -7.5835187395641555],
					const mmap = new mapboxgl.Map({
						container: 'map',
						style: 'mapbox://styles/mapbox/streets-v11',
						center: [112.12977836991575, -7.5835187395641555],
						zoom: 11,
						scrollZoom: true
					});
					var mapp = new Titiklokasi(mmap);
					mapp.tampilMap(hasil);
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					// app.dialog.alert(data['message'], 'Peringatan');
					var toast = app.toast.create({
						text: data['message'],
						position: 'bottom',
						horizontalPosition: 'right',
						closeTimeout: 2000,
					});
					toast.open();
					// app.views.main.router.back();
				}
			}, function (xhr, status, message) {
				// menampilkan jika ada error
				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}

		function load_lokasi_all(mapTitikLokasi) {
			console.log('load_lokasi_all');
			app.preloader.show();
			app.request.post(api_lokasi_all, {
				auth_key: localStorage.ls_id_user
			}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);
				app.preloader.hide();
				if (data['status'] === 'sukses') {
					var hasil = data['data'];

					console.log(mapTitikLokasi);
					var mapp = new Titiklokasi(mapTitikLokasi);
					mapp.tampilMap(hasil);
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					app.dialog.alert(data['message'], 'Peringatan');
					app.views.main.router.back();
				}
			}, function (xhr, status, message) {
				// menampilkan jika ada error
				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}

		function click_keterangan(id) {
			app.views.main.router.navigate("/baca-keterangan/?id=" + id);
		}

		// TAMBAHH-PEMILIKK-TANAHH
		function load_data_pemilik_tanah() {

			preload_div('tpt_blok_data');
			app.request.post(api_pemilik_tanah_all, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);

				if (data['status'] === 'sukses') {
					var results = data['data'];
					var totalHalaman = data['meta']['totalHalaman'];
					var totalData = data['meta']['totalData'];
					$('#tpt_total_data').html(totalData);

					// mmbuat variabel untuk menampung data perulangan
					var hasil = "";

					// proses perulangan
					for (x in results) {
						// mmbuat variabel data dari backend
						var id = results[x].id_pemilik_tanah;
						var na = results[x].nama_pemilik;
						var no = results[x].nomor_wa;

						hasil += `<li>
          <a href="#" class="item-link item-content" data-kode="` + id + `" data-nama="` + na + `" onclick="click_pilih_pemilik_tanah(this)">
            <div class="item-media"><i class="f7-icons">doc_plaintext</i></div>
            <div class="item-inner">
                <div class="item-title">` + na + `</div>
            </div>
          </a>
        </li>`;
					}
					$('#tpt_blok_data').html('<ul>' + hasil + '</ul>');
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					$('#tpt_blok_data').html('');
					app.dialog.alert(data['message'], 'Pemberitahuan');
				}
			}, function (xhr, status, message) {
				// menampilkan jika ada error
				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");

		}

		function click_pilih_pemilik_tanah(el) {
			console.log(el);

			// mengambil nilai di attribute
			var id = $(el).data('kode');
			var na = $(el).data('nama');

			// meletakan nilainya di sebuah inputan
			$('#tl_kepemilikan_tanah').val(na);
			$('#tl_kepemilikan_tanah_id').val(id);

			// menambahkan nilai di attribute dengan data-kode
			$('#tl_kepemilikan_tanah').attr('data-kode', id);

			// melakukan router back maksudnya itu kembali ke view sebelumnya
			app.views.main.router.back();
		}

		// TAMBAHH-DUSUNN
		function load_data_dusun() {

			preload_div('td_blok_data');
			app.request.post(api_dusun_all, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);

				if (data['status'] === 'sukses') {
					var results = data['data'];
					var totalHalaman = data['meta']['totalHalaman'];
					var totalData = data['meta']['totalData'];
					$('#td_total_data').html(totalData);

					// mmbuat variabel untuk menampung data perulangan
					var hasil = "";

					// proses perulangan
					for (x in results) {
						// mmbuat variabel data dari backend
						var id = results[x].id_dusun;
						var na = results[x].nama_dusun;

						hasil += `<li>
				          <a href="#" class="item-link item-content" data-kode="` + id + `" data-nama="` + na + `">
				            <div class="item-media"><i class="f7-icons">doc_plaintext</i></div>
				            <div class="item-inner">
				                <div class="item-title">` + na + `</div>
				            </div>
				          </a>
				        </li>`;
					}
					$('#td_blok_data').html('<ul>' + hasil + '</ul>');
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					$('#td_blok_data').html('');
					app.dialog.alert(data['message'], 'Pemberitahuan');
				}
			}, function (xhr, status, message) {
				// menampilkan jika ada error
				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");

		}

		function load_data_dusun_select() {
			app.request.post(api_dusun_all, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);

				if (data['status'] === 'sukses') {
					var results = data['data'];

					// mmbuat variabel untuk menampung data perulangan
					var hasil = "";

					// proses perulangan
					for (x in results) {
						// mmbuat variabel data dari backend
						var id = results[x].id_dusun;
						var na = results[x].nama_dusun;

						hasil += `<option value="` + id + `">` + na + `</option>`;
					}
					// perintah untuk meletakkan data yang diulang diletakan di blok data
					$('#tl_nama_dusun').html('<option value="">--Pilih Dusun--</option>' + hasil);
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					$('#tl_nama_dusun').html('<option value="">--Pilih Dusun--</option>');
				}

			}, function (xhr, status, message) {
				// menampilkan jika ada error

				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}

		// TAMBAHH-JENISS-BUAHH
		function load_data_jenis_buah() {

			preload_div('tjb_blok_data');
			app.request.post(api_jenis_buah_all, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);

				if (data['status'] === 'sukses') {
					var results = data['data'];
					var totalHalaman = data['meta']['totalHalaman'];
					var totalData = data['meta']['totalData'];
					$('#tjb_total_data').html(totalData);

					// mmbuat variabel untuk menampung data perulangan
					var hasil = "";

					// proses perulangan
					for (x in results) {
						// mmbuat variabel data dari backend
						var id = results[x].id_jenis_buah;
						var na = results[x].nama_jenis_buah;

						hasil += `<li>
				          <a href="#" class="item-link item-content" data-kode="` + id + `" data-nama="` + na + `">
				            <div class="item-media"><i class="f7-icons">doc_plaintext</i></div>
				            <div class="item-inner">
				                <div class="item-title">` + na + `</div>
				            </div>
				          </a>
				        </li>`;
					}
					$('#tjb_blok_data').html('<ul>' + hasil + '</ul>');
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					$('#tjb_blok_data').html('');
					app.dialog.alert(data['message'], 'Pemberitahuan');
				}
			}, function (xhr, status, message) {
				// menampilkan jika ada error
				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");

		}

		function load_data_jenis_buah_select() {
			app.request.post(api_jenis_buah_all, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				console.log(status);
				// console.log(xhr);

				if (data['status'] === 'sukses') {
					var results = data['data'];

					// mmbuat variabel untuk menampung data perulangan
					var hasil = "";

					// proses perulangan
					for (x in results) {
						// mmbuat variabel data dari backend
						var id = results[x].id_jenis_buah;
						var na = results[x].nama_jenis_buah;

						hasil += `<option value="` + id + `">` + na + `</option>`;
					}
					// perintah untuk meletakkan data yang diulang diletakan di blok data
					$('#tl_nama_jenis_buah').html('<option value="">--Pilih Jenis Buah--</option>' + hasil);
				} else if (data['status'] === 'auth_salah') {
					app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
						click_logout();
					});
				} else {
					$('#tl_nama_jenis_buah').html('<option value="">--Pilih Jenis Buah--</option>');
				}

			}, function (xhr, status, message) {
				// menampilkan jika ada error

				// console.log(xhr);
				console.log(status);
				console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}

		//	REKAP-VARIETAS
		function load_data_rekap() {
			// post ke server-api proses simpan data
			app.request.post(api_data_rekap_varietas, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				// console.log(status);
				// console.log(xhr);


				if (data['status'] === 'sukses') {
					var data_pengguna = '';
					if (data.data == 0) {
						// $('#html_data_pengguna').html(`<tr>
						//     <td colspan="6" class="text-align-center">Data Kosong</td>
						// </tr>`);
					} else {
						var thead = `<td style="min-width: 180px"></td>`;
						var tbody = '';
						for (const keyPengguna in data.data.dusun) {
							thead += `<td style="min-width: 50px" class="text-align-center">${data.data.dusun[keyPengguna].nama_dusun}</td>`;
						}
						for (const keyDB in data.data.jenis_buah) {
							tbody += `<tr><td>${data.data.jenis_buah[keyDB].nama_jenis_buah}</td>`;
							for (const keyDBJml in data.data.jenis_buah[keyDB].jumlah) {
								var jml = data.data.jenis_buah[keyDB].jumlah[keyDBJml].jml;
								if (jml == 0) {
									tbody += `<td class="text-align-center">${jml}</td>`;
								} else {
									tbody += `<td class="text-align-center"><b>${jml}</b></td>`;
								}
							}
							tbody += `</tr>`;
						}
						$('#html_thead_tr').html(thead);
						$('#html_data_rekap').html(tbody);
					}
				} else {
					// app.dialog.alert(data['message'], 'Pemberitahuan');
					// $('#html_data_pengguna').html(`<tr>
					// 	<td colspan="6">Data Kosong</td>
					// </tr>`);
				}

			}, function (xhr, status, message) {
				// console.log(xhr);
				// console.log(status);
				// console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}

		//	PENGGUNA
		function click_proses_pengguna(id_user, jenis) {
			console.log(jenis, id_user);

			if (jenis == 'edit') {
				//  ketika jenis adalah edit

				app.request.post(api_pengguna_edit, {
					auth_key: localStorage.ls_id_user,
					id_user: id_user
				}, function (data, status, xhr) {
					console.log(data);
					console.log(status);
					// console.log(xhr);

					if (data['status'] === 'sukses') {
						var results = data['data'];

						var nama = data.data['nama'];
						var id_user = data.data['id_user'];
						var nomor_wa = data.data['nomor_wa'];
						var username = data.data['username'];
						var params = `?nama=${nama}&id_user=${id_user}&nomor_wa=${nomor_wa}&username=${username}`;
						console.log(params);
						app.views.main.router.navigate("/pengguna-edit/" + params);

					} else if (data['status'] === 'auth_salah') {
						app.dialog.alert('Terjadi ' + data['message'] + ' Login Kembali!', 'Pemberitahuan', function () {
							click_logout();
						});
					} else {
						app.dialog.alert(data['message'], 'Pemberitahuan');
					}
				}, function (xhr, status, message) {
					// menampilkan jika ada error
					// console.log(xhr);
					console.log(status);
					console.log(message);

					// panggil fungsi untuk menampilkan error
					info_error(status);
				}, "json");
			} else {
				//  ketika jenis adalah selain edit
				app.dialog.confirm('Yakin ingin hapus data?', 'Pertanyaan', function () {
					/*eksekusi*/
					app.request.post(api_pengguna_hapus, {
						auth_key: localStorage.ls_id_user,
						id_user: id_user
					}, function (data, status, xhr) {
						console.log(data);
						// console.log(status);
						// console.log(xhr);

						if (data['status'] === 'sukses') {
							load_data_pengguna();
						} else {
							app.dialog.alert(data['message'], 'Pemberitahuan');
						}

					}, function (xhr, status, message) {
						console.log(xhr);
						console.log(status);
						// console.log(message);

						// panggil fungsi untuk menampilkan error
						info_error(status);
					}, "json");
				});
			}
		}

		function load_data_pengguna() {
			// post ke server-api proses simpan data
			app.request.post(api_data_pengguna, {auth_key: localStorage.ls_id_user}, function (data, status, xhr) {
				console.log(data);
				// console.log(status);
				// console.log(xhr);

				if (data['status'] === 'sukses') {
					var no = 1;
					var data_pengguna = '';
					if (data.data == 0) {
						$('#html_data_pengguna').html(`<tr>
		                    <td colspan="6" class="text-align-center">Data Kosong</td>
		                </tr>`);
					} else {
						for (const keyPengguna in data.data) {
							// console.log(data.data[keyPengguna].nama)
							// console.log(data.data[keyPengguna]['nama'])
							var nama = data.data[keyPengguna]['nama'];
							var date_create = data.data[keyPengguna]['date_create'];
							var id_user = data.data[keyPengguna]['id_user'];
							var nomor_wa = data.data[keyPengguna]['nomor_wa'];
							var username = data.data[keyPengguna]['username'];

							data_pengguna += `<tr>
		                        <td class="label-cell">${no}</td>
		                        <td class="">${nama}</td>
		                        <td class="">${nomor_wa}</td>
		                        <td class="">${username}</td>
		                        <td class="">${date_create}</td>
		                        <td class="">
		                            <button onclick="click_proses_pengguna('${id_user}','edit')" class="col button button-small button-fill color-blue">Edit</button>
		                            <button onclick="click_proses_pengguna('${id_user}','hapus')" class="col button button-small button-fill color-red">Hapus</button>
		                        </td>
		                    </tr>`;
							no++;
						}
						$('#html_data_pengguna').html(data_pengguna);
					}
				} else {
					app.dialog.alert(data['message'], 'Pemberitahuan');
					$('#html_data_pengguna').html(`<tr>
		    	<td colspan="6">Data Kosong</td>
		    </tr>`);
				}

			}, function (xhr, status, message) {
				// console.log(xhr);
				// console.log(status);
				// console.log(message);

				// panggil fungsi untuk menampilkan error
				info_error(status);
			}, "json");
		}
	</script>
</body>

</html>
